{% extends 'vendas/base.html' %}
{% load static %}
{% block content %}
	<div class="row">
		<div class="col-lg-6">
			<div class="box-element" id="form-wrapper">
				<form id="form">
					<div id="shipping-info">
						<p>Modo de Pagamento:</p>
						<div class="form-field">
							<select name="pgto" id="pgto">
								<option value="credito">Credito</option>
								<option value="debito">Debito</option>
								<option value="pix">Pix</option>
								<option value="boleto">Boleto</option>
							</select>
						</div>
						
					</div>

					<hr>
					<input id="form-button" class="btn btn-success btn-block" type="submit"
						value="Continue">
				</form>
			</div>

			<br>
		</div>

		<div class="col-lg-6">
			<div class="box-element">
				<a class="btn btn-outline-dark" href="{% url 'carrinho' %}">&#x2190; voltar
					ao carrinho</a>
				<hr>
				<h5>Cliente nivel {{pedido.revendedor.meta.nivel}}</h5>
				<h3>Resumo do pedido</h3>
				<hr>
				{% for item in itens %}
				<div class="carrinho-row">
					<div style="flex:2"><img class="row-image" src="{{item.produto.imageURL}}"></div>
					<div style="flex:2"><p>{{item.produto.nome}}</p></div>
					<div style="flex:1"><p>${{item.produto.preco|floatformat:2}}</p></div>
					<div style="flex:1"><p>x{{item.quantidade}}</p></div>
				</div>
				{% endfor %}
				<h5>Itens: {{pedido.get_carrinho_itens}}</h5>
				{% if pedido.revendedor.user.type == 'REVENDEDOR' %}
					<h5>Subtotal: ${{pedido.get_carrinho_total|floatformat:2}}</h5>
				  	<h5>Desconto: %{{pedido.revendedor.meta.desconto}}</h5>
					<h5>Total: ${{pedido.get_meta_total|floatformat:2}}</h5>
				{% elif pedido.loja.user.type == 'LOJA' %}
					<h5>Total: ${{pedido.get_carrinho_total|floatformat:2}}</h5>
				{% endif %}
				
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>

	<script type="text/javascript">
		
		if ('{{pedido.revendedor.user.type}}' == 'REVENDEDOR'){
			var subtotal = '{{pedido.get_carrinho_total}}';
			var total = '{{pedido.get_meta_total}}';
			
		}else if ('{{pedido.loja.user.type}}' == 'LOJA')
			var total = '{{pedido.get_carrinho_total}}';
			var subtotal = '{{pedido.get_carrinho_total}}';

			var form = document.getElementById('form')
			form.addEventListener('submit', function(e){
				e.preventDefault()
				document.getElementById('form-button').classList.add("hidden");
				var formaPgto = $("#pgto").val()
				submitFormData(formaPgto)
			})

			function submitFormData(formaPgto){
				var userFormData = {
					'subtotal':subtotal,
					'total':total,
					'formaPgto':formaPgto,
				}

				var url = "/processarPedido/"
				fetch(url, {
					method:'POST',
					headers:{
						'Content-Type':'applicaiton/json',
						'X-CSRFToken':csrftoken,
					}, 
					body:JSON.stringify({'form':userFormData}),
					
				})
				.then((response) => response.json())
				.then((data) => {

					carrinho = {}
					document.cookie ='carrinho=' + JSON.stringify(carrinho) + ";domain=;path=/"

					window.location.href = "{% url 'vendas-home' %}"

					})
			}
	</script>
{% endblock content %}